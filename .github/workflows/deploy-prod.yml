name: Production Deployment Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: [self-hosted, Linux]
    timeout-minutes: 20

    steps:
      - name: üöÄ Deploy Production Application
        run: |
          echo "======================================"
          echo "Starting Production Deployment"
          echo "======================================"

          # Go to production directory
          cd /home/ubuntu/Edify-Service-Chatbot-Agent

          echo "üì• Pulling latest code..."
          git fetch origin
          git reset --hard origin/main

          echo "üõë Stopping existing containers..."
          docker compose -f docker-compose.prod.yml down --remove-orphans

          echo "üî® Building Docker image..."
          docker compose -f docker-compose.prod.yml build

          echo "‚ñ∂Ô∏è Starting containers..."
          docker compose -f docker-compose.prod.yml up -d --force-recreate

          echo "‚úÖ Production deployment completed"

      - name: üîé Verify Deployment
        run: |
          echo "Waiting for container..."
          sleep 10

          if docker ps | grep -q edify-chatbot-prod; then
            echo "‚úÖ Production container is running"
            docker ps | grep edify-chatbot-prod

            echo "Checking health endpoint..."
            curl -f http://localhost:8081/health || echo "‚ö†Ô∏è Health endpoint not ready yet"
          else
            echo "‚ùå Container failed to start"
            docker logs edify-chatbot-prod
            exit 1
          fi
